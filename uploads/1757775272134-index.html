<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>Eberardos Uploader</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="icon" href="https://i.ibb.co/r2KDVBJC/IMG-20241225-WA0318.jpg" type="image/jpeg">
    <style>
        :root{--primary:#e63946;--primary-dark:#d90429;--secondary:#2b2d42;--secondary-light:#414563;--accent:#fca311;--light:#f8f9fa;--dark:#212529;--gray:#8d99ae;--success:#2a9d8f;--error:#e63946}*{margin:0;padding:0;box-sizing:border-box;font-family:"Poppins","Segoe UI",Tahoma,Geneva,Verdana,sans-serif}body{background:linear-gradient(135deg,#0c0c0c 0%,#2b2d42 100%);color:var(--light);line-height:1.6;min-height:100vh;padding:0}.container{max-width:1200px;margin:0 auto;padding:20px}header{text-align:center;padding:30px 0;background:rgba(43,45,66,0.8);backdrop-filter:blur(10px);color:white;border-radius:16px;margin-bottom:30px;box-shadow:0 8px 32px rgba(0,0,0,0.3);border:1px solid rgba(255,255,255,0.1);position:relative;overflow:hidden}header::before{content:"";position:absolute;top:0;left:0;width:100%;height:5px;background:linear-gradient(90deg,var(--primary),var(--accent))}h1{font-size:3rem;margin-bottom:10px;font-weight:800;background:linear-gradient(90deg,var(--primary),var(--accent));-webkit-background-clip:text;-webkit-text-fill-color:transparent;text-shadow:0 2px 10px rgba(230,57,70,0.3)}.logo{font-size:2.5rem;margin-bottom:15px;color:var(--primary)}.upload-section{background:rgba(43,45,66,0.8);backdrop-filter:blur(10px);padding:30px;border-radius:16px;box-shadow:0 8px 32px rgba(0,0,0,0.3);margin-bottom:30px;text-align:center;border:1px solid rgba(255,255,255,0.1)}.section-title{font-size:1.8rem;margin-bottom:20px;color:var(--light);position:relative;display:inline-block}.section-title::after{content:"";position:absolute;bottom:-10px;left:50%;transform:translateX(-50%);width:50px;height:3px;background:var(--primary);border-radius:3px}.upload-area{border:2px dashed var(--gray);border-radius:12px;padding:40px 20px;margin:20px 0;cursor:pointer;transition:all 0.3s ease;background:rgba(33,37,41,0.4)}.upload-area:hover{border-color:var(--primary);background:rgba(230,57,70,0.1);transform:translateY(-5px);box-shadow:0 10px 20px rgba(0,0,0,0.2)}.upload-area.dragover{border-color:var(--primary);background:rgba(230,57,70,0.2)}.upload-icon{font-size:60px;color:var(--primary);margin-bottom:15px;transition:all 0.3s ease}.upload-area:hover .upload-icon{transform:scale(1.1)}.btn{background:linear-gradient(90deg,var(--primary),var(--primary-dark));color:white;border:none;padding:14px 28px;border-radius:50px;cursor:pointer;font-size:16px;font-weight:600;transition:all 0.3s ease;box-shadow:0 4px 15px rgba(230,57,70,0.4);display:inline-flex;align-items:center;justify-content:center;gap:8px}.btn:hover{transform:translateY(-3px);box-shadow:0 8px 20px rgba(230,57,70,0.6)}.btn:disabled{background:var(--gray);cursor:not-allowed;transform:none;box-shadow:none}#file-input{display:none}.gallery-section{background:rgba(43,45,66,0.8);backdrop-filter:blur(10px);padding:30px;border-radius:16px;box-shadow:0 8px 32px rgba(0,0,0,0.3);border:1px solid rgba(255,255,255,0.1)}.gallery-title{text-align:center;margin-bottom:30px;color:var(--light);font-size:1.8rem;position:relative;display:inline-block;left:50%;transform:translateX(-50%)}.gallery-title::after{content:"";position:absolute;bottom:-10px;left:50%;transform:translateX(-50%);width:50px;height:3px;background:var(--primary);border-radius:3px}.gallery-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(250px,1fr));gap:20px;margin-top:20px}.gallery-item{border-radius:12px;overflow:hidden;box-shadow:0 5px 15px rgba(0,0,0,0.2);transition:all 0.3s ease;background:rgba(33,37,41,0.6);border:1px solid rgba(255,255,255,0.1);cursor:pointer;position:relative}.gallery-item:hover{transform:translateY(-5px) scale(1.02);box-shadow:0 12px 30px rgba(0,0,0,0.3)}.gallery-image{width:100%;height:200px;object-fit:cover;display:block}.image-info{padding:15px;font-size:0.9rem}.image-name{font-weight:600;color:var(--light);margin-bottom:5px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}.image-date{color:var(--gray);font-size:0.8rem}.progress-bar{height:10px;background-color:rgba(33,37,41,0.5);border-radius:5px;margin:20px 0;overflow:hidden}.progress{height:100%;background:linear-gradient(90deg,var(--primary),var(--accent));width:0%;transition:width 0.3s ease;border-radius:5px}.status-message{margin:15px 0;font-weight:500;padding:12px;border-radius:8px;text-align:center}.success{background:rgba(42,157,143,0.2);color:var(--success);border:1px solid rgba(42,157,143,0.3)}.error{background:rgba(230,57,70,0.2);color:var(--error);border:1px solid rgba(230,57,70,0.3)}footer{text-align:center;padding:20px;margin-top:40px;color:var(--gray);border-top:1px solid rgba(255,255,255,0.1)}.footer-content{display:flex;justify-content:center;align-items:center}.modal{display:none;position:fixed;z-index:1000;left:0;top:0;width:100%;height:100%;background-color:rgba(0,0,0,0.9);backdrop-filter:blur(5px);overflow:hidden;animation:fadeIn 0.3s ease}@keyframes fadeIn{from{opacity:0}to{opacity:1}}.modal-content{display:flex;flex-direction:column;justify-content:center;align-items:center;height:100%;padding:20px}.modal-image{max-width:90%;max-height:80%;object-fit:contain;border-radius:8px;box-shadow:0 5px 25px rgba(0,0,0,0.5)}.modal-info{margin-top:20px;color:white;text-align:center;max-width:80%}.modal-actions{margin-top:20px;display:flex;gap:15px}.modal-btn{background:rgba(255,255,255,0.2);color:white;border:none;padding:10px 20px;border-radius:50px;cursor:pointer;font-size:16px;transition:all .3s ease;display:inline-flex;align-items:center;justify-content:center;gap:8px;backdrop-filter:blur(10px);text-align:center;min-width:120px}.modal-btn i{width:16px;text-align:center}.modal-btn:hover{background:rgba(255,255,255,0.3)}.close{position:absolute;top:20px;right:30px;color:white;font-size:40px;font-weight:bold;cursor:pointer;transition:0.3s}.close:hover{color:var(--primary)}@media (max-width:768px){.container{padding:15px}h1{font-size:2.2rem}.upload-section,.gallery-section{padding:20px}.gallery-grid{grid-template-columns:repeat(auto-fill,minmax(150px,1fr));gap:15px}.upload-area{padding:30px 15px}.btn{padding:12px 24px}.modal-image{max-width:95%;max-height:60%}.modal-actions{flex-direction:column;gap:10px}}::-webkit-scrollbar{width:10px}::-webkit-scrollbar-track{background:rgba(43,45,66,0.5)}::-webkit-scrollbar-thumb{background:var(--primary);border-radius:5px}::-webkit-scrollbar-thumb:hover{background:var(--primary-dark)}.loading{display:inline-block;width:20px;height:20px;border:3px solid rgba(255,255,255,0.3);border-radius:50%;border-top-color:#fff;animation:spin 1s ease-in-out infinite}@keyframes spin{to{transform:rotate(360deg)}}.custom-name-container{margin:20px 0;text-align:left;max-width:500px;margin-left:auto;margin-right:auto}.custom-name-label{display:block;margin-bottom:8px;font-weight:600;color:var(--light)}.custom-name-input{width:100%;padding:12px 16px;border-radius:8px;border:1px solid rgba(255,255,255,0.2);background:rgba(33,37,41,0.4);color:var(--light);font-size:16px;transition:all 0.3s ease}.custom-name-input:focus{outline:none;border-color:var(--primary);box-shadow:0 0 0 2px rgba(230,57,70,0.3)}.custom-name-hint{font-size:14px;color:var(--gray);margin-top:5px}

        /* Tambahan style untuk kompatibilitas */
        .browser-support-check {
            display: none;
            background: rgba(230, 57, 70, 0.2);
            border: 1px solid var(--error);
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 20px;
            text-align: left;
        }
        
        .browser-support-check.show {
            display: block;
        }
        
        .support-list {
            margin-top: 10px;
            padding-left: 20px;
        }
        
        .support-list li {
            margin-bottom: 5px;
            font-size: 14px;
        }
        
        .legacy-upload {
            margin-top: 15px;
            display: none;
        }
        
        .legacy-upload.show {
            display: block;
        }
        
        .file-input-label {
            display: inline-block;
            background: var(--secondary);
            color: white;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
            transition: background 0.3s;
        }
        
        .file-input-label:hover {
            background: var(--secondary-light);
        }
        
        /* Style untuk tombol Share */
        .share-btn {
            background: transparent;
            color: var(--gray);
            border: 1px solid var(--gray);
            padding: 5px 10px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 0.8rem;
            margin-top: 8px;
            transition: all 0.3s ease;
            width: 100%;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 5px;
        }
        
        .share-btn:hover {
            color: var(--accent);
            border-color: var(--accent);
        }
        
        /* Style untuk modal share */
        .share-modal {
            display: none;
            position: fixed;
            z-index: 1001;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.7);
            backdrop-filter: blur(5px);
        }
        
        .share-modal-content {
            background: rgba(43, 45, 66, 0.95);
            margin: 15% auto;
            padding: 20px;
            border-radius: 12px;
            width: 300px;
            text-align: center;
            box-shadow: 0 5px 25px rgba(0, 0, 0, 0.5);
            border: 1px solid rgba(255, 255, 255, 0.1);
        }
        
        .share-options {
            display: flex;
            justify-content: center;
            gap: 15px;
            margin: 20px 0;
        }
        
        .share-option {
            background: rgba(33, 37, 41, 0.6);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 50%;
            width: 50px;
            height: 50px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        
        .share-option:hover {
            transform: scale(1.1);
            border-color: var(--primary);
            background: rgba(230, 57, 70, 0.2);
        }
        
        .share-option i {
            font-size: 20px;
        }
        
        .copy-link-btn {
            background: linear-gradient(90deg, var(--primary), var(--primary-dark));
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 50px;
            cursor: pointer;
            font-size: 14px;
            transition: all 0.3s ease;
            display: inline-flex;
            align-items: center;
            gap: 8px;
            margin-top: 10px;
        }
        
        .copy-link-btn:hover {
            transform: translateY(-2px);
        }
        
        .share-url {
            background: rgba(33, 37, 41, 0.6);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 5px;
            padding: 10px;
            margin: 15px 0;
            word-break: break-all;
            font-size: 12px;
            text-align: center;
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <div class="logo"><i class="fas fa-cloud-upload-alt"></i></div>
            <h1>Ebd Uploader</h1>
            <p>upload foto disini agar tersimpan di Eberardos selamanyaðŸ˜ˆ</p>
        </header>
        
        <div id="browser-support" class="browser-support-check">
            <h3><i class="fas fa-exclamation-triangle"></i> Perhatian: Masalah Kompatibilitas Browser</h3>
            <p>Browser Anda mungkin memiliki masalah dengan fitur upload. Silakan coba:</p>
            <ul class="support-list">
                <li>Gunakan browser modern seperti Chrome, Firefox, atau Edge</li>
                <li>Pastikan JavaScript diaktifkan</li>
                <li>Izinkan akses file jika diminta</li>
            </ul>
        </div>
        
        <section class="upload-section">
            <h2 class="section-title">Upload Image</h2>
            
            <div class="upload-area" id="upload-area">
                <div class="upload-icon"><i class="fas fa-file-image"></i></div>
                <p>Click or drag an image here to upload.</p>
                <p style="font-size:14px;color:var(--gray)">JPG, PNG, GIF (Max. 5MB)</p>
            </div>
            
            <div id="legacy-upload" class="legacy-upload">
                <p style="margin:10px 0;color:var(--gray)">Atau gunakan metode upload tradisional:</p>
                <label for="file-input-legacy" class="file-input-label">
                    <i class="fas fa-folder-open"></i> Pilih Gambar
                </label>
                <input type="file" id="file-input-legacy" accept="image/jpeg,image/png,image/gif" style="display:none">
            </div>
            
            <div class="custom-name-container" id="custom-name-container" style="display:none">
                <label class="custom-name-label" for="custom-name-input">Photo Name</label>
                <input type="text" id="custom-name-input" class="custom-name-input" placeholder="Masukkan nama untuk foto ini..." maxlength="100">
                <p class="custom-name-hint">Jika dikosongkan, akan menggunakan nama file asli</p>
            </div>
            
            <input type="file" id="file-input" accept="image/jpeg,image/png,image/gif, video/mp4">
            
            <div class="progress-bar">
                <div class="progress" id="progress-bar"></div>
            </div>
            
            <p class="status-message" id="status-message"></p>
            
            <button class="btn" id="upload-btn" disabled>
                <i class="fas fa-upload"></i> Upload
            </button>
        </section>
        
        <section class="gallery-section">
            <h2 class="gallery-title">Eberardos Gallery</h2>
            <div class="gallery-grid" id="gallery">
                <div class="loading-message">
                    <div class="loading"></div>
                    <p>Memuat gambar...</p>
                </div>
            </div>
        </section>
        
        <div id="image-modal" class="modal">
            <span class="close">&times;</span>
            <div class="modal-content">
                <img id="modal-image" class="modal-image" src="" alt="">
                <div class="modal-info">
                    <h3 id="modal-title"></h3>
                    <p id="modal-date"></p>
                </div>
                <div class="modal-actions">
                    <button id="download-btn" class="modal-btn">
                        <i class="fas fa-download"></i> Download
                    </button>
                    <button id="modal-share-btn" class="modal-btn">
                        <i class="fas fa-share-alt"></i> Share
                    </button>
                </div>
            </div>
        </div>
        
        <!-- Modal Share -->
        <div id="share-modal" class="share-modal">
            <div class="share-modal-content">
                <h3>Bagikan Gambar</h3>
                <div class="share-options">
                    <div class="share-option" id="share-whatsapp">
                        <i class="fab fa-whatsapp" style="color: #25D366;"></i>
                    </div>
                    <div class="share-option" id="share-telegram">
                        <i class="fab fa-telegram" style="color: #0088cc;"></i>
                    </div>
                    <div class="share-option" id="share-facebook">
                        <i class="fab fa-facebook" style="color: #3b5998;"></i>
                    </div>
                </div>
                <div class="share-url" id="share-url">Loading...</div>
                <button id="copy-link-btn" class="copy-link-btn">
                    <i class="fas fa-link"></i> Salin Link
                </button>
                <p id="share-status" style="margin-top: 10px; font-size: 14px; color: var(--success); display: none;">
                    Link berhasil disalin!
                </p>
            </div>
        </div>
        
        <footer>
            <div class="footer-content">
                <p>Eberardos Uploader &copy; 2025</p>
            </div>
        </footer>
    </div>

    <script>
        const supabaseUrl = "https://hcdmotcyklhdttadpddo.supabase.co";
const supabaseKey = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImhjZG1vdGN5a2xoZHR0YWRwZGRvIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTU3ODY2MjcsImV4cCI6MjA3MTM2MjYyN30.ia-iUhJsKXljHZbxrGsqp94X1EatkmqmFsIXsnZpwPk";
const supabase = window.supabase.createClient(supabaseUrl, supabaseKey);
const WEBSITE_BASE_URL = window.location.origin || "https://gallery.eberardos.my.id";

// Elemen DOM
const uploadArea = document.getElementById("upload-area");
const fileInput = document.getElementById("file-input");
const fileInputLegacy = document.getElementById("file-input-legacy");
const uploadBtn = document.getElementById("upload-btn");
const progressBar = document.getElementById("progress-bar");
const statusMessage = document.getElementById("status-message");
const gallery = document.getElementById("gallery");
const modal = document.getElementById("image-modal");
const modalImage = document.getElementById("modal-image");
const modalTitle = document.getElementById("modal-title");
const modalDate = document.getElementById("modal-date");
const downloadBtn = document.getElementById("download-btn");
const modalShareBtn = document.getElementById("modal-share-btn");
const closeBtn = document.querySelector(".close");
const customNameContainer = document.getElementById("custom-name-container");
const customNameInput = document.getElementById("custom-name-input");
const browserSupport = document.getElementById("browser-support");
const legacyUpload = document.getElementById("legacy-upload");
const shareModal = document.getElementById("share-modal");
const shareWhatsapp = document.getElementById("share-whatsapp");
const shareTelegram = document.getElementById("share-telegram");
const shareFacebook = document.getElementById("share-facebook");
const copyLinkBtn = document.getElementById("copy-link-btn");
const shareStatus = document.getElementById("share-status");
const shareUrl = document.getElementById("share-url");

let selectedFile = null;
let currentImage = null;
let currentShareUrl = "";

// Fungsi untuk generate kode acak (6 karakter)
function generateShortCode() {
  const chars = 'ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789';
  let result = '';
  for (let i = 0; i < 6; i++) {
    result += chars.charAt(Math.floor(Math.random() * chars.length));
  }
  return result;
}

// Fungsi cek kode unik
async function isShortCodeUnique(code) {
  const { data, error } = await supabase
    .from("images")
    .select("short_code")
    .eq("short_code", code)
    .single();
  return !data;
}

function checkBrowserSupport() {
  const fileInputSupport = 'files' in document.createElement('input');
  const fileReaderSupport = window.FileReader !== undefined;
  const dragDropSupport = 'ondragstart' in document.createElement('div') && 'ondrop' in document.createElement('div');
  
  if (!fileInputSupport || !fileReaderSupport) {
    browserSupport.classList.add('show');
    legacyUpload.classList.add('show');
    return false;
  }
  
  if (!dragDropSupport) {
    legacyUpload.classList.add('show');
  }
  
  return true;
}

function sanitizeHTML(text) {
  const div = document.createElement("div");
  div.textContent = text;
  return div.innerHTML;
}

function sanitizeFilename(filename) {
  return filename
    .replace(/[^a-zA-Z0-9_\u0600-\u06FF\u4e00-\u9fa5\u00C0-\u017F\s.-]/g, '_')
    .replace(/\s+/g, '_')
    .substring(0, 100);
}

// Event Listeners
uploadArea.addEventListener("click", () => { fileInput.click(); });
uploadArea.addEventListener("dragover", (e) => { e.preventDefault(); uploadArea.classList.add("dragover"); });
uploadArea.addEventListener("dragleave", () => { uploadArea.classList.remove("dragover"); });
uploadArea.addEventListener("drop", (e) => {
  e.preventDefault();
  uploadArea.classList.remove("dragover");
  if (e.dataTransfer.files.length) handleFileSelect(e.dataTransfer.files[0]);
});
fileInput.addEventListener("change", (e) => { if (e.target.files.length) handleFileSelect(e.target.files[0]); });
fileInputLegacy.addEventListener("change", (e) => { if (e.target.files.length) handleFileSelect(e.target.files[0]); });
uploadBtn.addEventListener("click", uploadFile);
closeBtn.addEventListener("click", () => { modal.style.display = "none"; });
downloadBtn.addEventListener("click", downloadImage);
modalShareBtn.addEventListener("click", () => { if (currentImage) openShareModal(currentImage); });
shareWhatsapp.addEventListener("click", () => { shareToWhatsapp(); });
shareTelegram.addEventListener("click", () => { shareToTelegram(); });
shareFacebook.addEventListener("click", () => { shareToFacebook(); });
copyLinkBtn.addEventListener("click", () => { copyToClipboard(); });
window.addEventListener("click", (e) => {
  if (e.target === modal) modal.style.display = "none";
  if (e.target === shareModal) {
    shareModal.style.display = "none";
    shareStatus.style.display = "none";
  }
});

function handleFileSelect(file) {
  const allowedTypes = ["image/jpeg", "image/png", "image/gif", "video/mp4"];
  const maxSize = 5 * 1024 * 1024;
  
  if (!allowedTypes.includes(file.type)) {
    return showStatus("Hanya file JPG, PNG, dan GIF yang diperbolehkan", "error");
  }
  
  if (file.size > maxSize) {
    return showStatus("Ukuran file maksimal 5MB", "error");
  }
  
  selectedFile = file;
  uploadBtn.disabled = false;
  customNameContainer.style.display = "block";
  
  const reader = new FileReader();
  reader.onload = (e) => {
    uploadArea.innerHTML = `<img src="${e.target.result}" style="max-width:100%;max-height:200px;border-radius:5px;margin-bottom:10px;"><p>${sanitizeHTML(file.name)}</p><p style="font-size:14px;color:var(--gray)">Klik tombol Upload untuk mengirim gambar</p>`;
  };
  reader.readAsDataURL(file);
  showStatus("File siap diupload", "success");
}

async function uploadFile() {
  if (!selectedFile) return;
  
  uploadBtn.disabled = true;
  progressBar.style.width = "0%";
  showStatus("Mengupload...", "");
  
  try {
    // Generate kode unik
    let shortCode;
    let isUnique = false;
    let attempts = 0;
    
    while (!isUnique && attempts < 10) {
      shortCode = generateShortCode();
      isUnique = await isShortCodeUnique(shortCode);
      attempts++;
    }
    
    if (!isUnique) {
      showStatus("Gagal generate kode unik, coba lagi", "error");
      uploadBtn.disabled = false;
      return;
    }
    
    const fileName = customNameInput.value.trim();
    const sanitizedFileName = sanitizeHTML(fileName || selectedFile.name);
    const fileExtension = selectedFile.name.split('.').pop();
    const originalName = selectedFile.name.slice(0, selectedFile.name.lastIndexOf('.'));
    const sanitizedBaseName = sanitizeFilename(fileName || originalName);
    const storageFileName = `${sanitizedBaseName}_${Date.now()}.${fileExtension}`;
    
    let progress = 0;
    const progressInterval = setInterval(() => {
      progress += 5;
      if (progress <= 95) {
        progressBar.style.width = `${progress}%`;
      }
    }, 200);
    
    // Upload file ke storage
    const { data: uploadData, error: uploadError } = await supabase.storage
      .from("images")
      .upload(storageFileName, selectedFile, {
        cacheControl: '3600',
        upsert: false
      });
    
    clearInterval(progressInterval);
    progressBar.style.width = "100%";
    
    if (uploadError) {
      throw uploadError;
    }
    
    // Dapatkan URL publik
    const { data: publicUrlData } = supabase.storage
      .from("images")
      .getPublicUrl(storageFileName);
    
    // Simpan metadata termasuk short_code
    const { error: metadataError } = await supabase
      .from("images")
      .insert([{
        name: storageFileName,
        original_name: sanitizedFileName,
        url: publicUrlData.publicUrl,
        short_code: shortCode,
        uploaded_at: new Date().toISOString()
      }]);
    
    if (metadataError) {
      console.error("Error menyimpan metadata:", metadataError);
    }
    
    showStatus("Upload berhasil!", "success");
    setTimeout(() => {
      resetUploadForm();
      loadImages();
    }, 1500);
    
  } catch (error) {
    console.error("Error uploading file:", error);
    showStatus("Error saat upload: " + error.message, "error");
    uploadBtn.disabled = false;
  }
}

async function loadImages() {
  try {
    gallery.innerHTML = `<div style="text-align:center;grid-column:1/-1"><div class="loading" style="margin:0 auto"></div><p style="color:var(--gray);margin-top:10px">Memuat gambar...</p></div>`;
    
    const { data: images, error } = await supabase
      .from("images")
      .select("*")
      .order("uploaded_at", { ascending: false });
    
    if (error) throw error;
    
    gallery.innerHTML = "";
    
    if (images.length === 0) {
      gallery.innerHTML = '<p style="text-align:center;grid-column:1/-1;color:var(--gray)">Belum ada gambar yang diupload</p>';
      return;
    }
    
    images.forEach(image => {
      const item = document.createElement("div");
      item.className = "gallery-item";
      item.dataset.id = image.id;
      
      const uploadDate = new Date(image.uploaded_at);
      const formattedDate = uploadDate.toLocaleDateString("id-ID", {
        day: "numeric",
        month: "long",
        year: "numeric"
      });
      
      item.innerHTML = `
        <img src="${image.url}" alt="${sanitizeHTML(image.original_name)}" class="gallery-image">
        <div class="image-info">
          <div class="image-name">${sanitizeHTML(image.original_name)}</div>
          <div class="image-date">Diupload: ${formattedDate}</div>
          <button class="share-btn" data-image-id="${image.id}" data-image-url="${image.url}" data-image-name="${sanitizeHTML(image.original_name)}">
            <i class="fas fa-share-alt"></i> Share
          </button>
        </div>
      `;
      
      item.addEventListener("click", (e) => {
        if (!e.target.classList.contains('share-btn') && !e.target.closest('.share-btn')) {
          openModal(image);
        }
      });
      
      const shareBtn = item.querySelector('.share-btn');
      shareBtn.addEventListener('click', (e) => {
        e.stopPropagation();
        openShareModal(image);
      });
      
      gallery.appendChild(item);
    });
  } catch (error) {
    console.error("Error loading images:", error);
    gallery.innerHTML = `<p style="text-align:center;grid-column:1/-1;color:var(--error)">Error memuat gambar. Pastikan tabel "images" ada di database Supabase.</p>`;
  }
}

function openModal(image) {
  currentImage = image;
  modalImage.src = image.url;
  modalTitle.textContent = sanitizeHTML(image.original_name);
  
  const uploadDate = new Date(image.uploaded_at);
  const formattedDate = uploadDate.toLocaleDateString("id-ID", {
    day: "numeric",
    month: "long",
    year: "numeric",
    hour: "2-digit",
    minute: "2-digit"
  });
  
  modalDate.textContent = `Diupload: ${formattedDate}`;
  modal.style.display = "block";
}

function openShareModal(image) {
currentShareUrl = `${WEBSITE_BASE_URL}/preview/${image.short_code}`;
  shareUrl.textContent = currentShareUrl;
  shareModal.style.display = "block";
  shareStatus.style.display = "none";
}

function shareToWhatsapp() {
  const text = encodeURIComponent(`Lihat gambar ini di Eberardos Gallery: ${currentShareUrl}`);
  window.open(`https://wa.me/?text=${text}`, '_blank');
}

function shareToTelegram() {
  const text = encodeURIComponent(`Lihat gambar ini di Eberardos Gallery: ${currentShareUrl}`);
  window.open(`https://t.me/share/url?url=${encodeURIComponent(currentShareUrl)}&text=${text}`, '_blank');
}

function shareToFacebook() {
  window.open(`https://www.facebook.com/sharer/sharer.php?u=${encodeURIComponent(currentShareUrl)}`, '_blank');
}

function copyToClipboard() {
  navigator.clipboard.writeText(currentShareUrl).then(() => {
    shareStatus.style.display = "block";
    setTimeout(() => {
      shareStatus.style.display = "none";
    }, 2000);
  }).catch(error => {
    console.error('Gagal menyalin link: ', error);
    alert('Gagal menyalin link ðŸ˜¢');
  });
}

function downloadImage() {
  if (!currentImage) return;
  
  fetch(currentImage.url)
    .then(response => response.blob())
    .then(blob => {
      const url = URL.createObjectURL(blob);
      const a = document.createElement("a");
      a.href = url;
      a.download = currentImage.original_name || "download";
      document.body.appendChild(a);
      a.click();
      
      setTimeout(() => {
        document.body.removeChild(a);
        URL.revokeObjectURL(url);
      }, 100);
    })
    .catch(error => {
      console.error('Error downloading image:', error);
      const a = document.createElement("a");
      a.href = currentImage.url;
      a.download = currentImage.original_name || "download";
      document.body.appendChild(a);
      a.click();
      document.body.removeChild(a);
    });
}

function resetUploadForm() {
  uploadArea.innerHTML = `
    <div class="upload-icon"><i class="fas fa-file-image"></i></div>
    <p>Klik atau seret gambar ke sini untuk mengupload</p>
    <p style="font-size:14px;color:var(--gray)">Format yang didukung: JPG, PNG, GIF (Maks. 5MB)</p>
  `;
  fileInput.value = "";
  fileInputLegacy.value = "";
  selectedFile = null;
  customNameInput.value = "";
  customNameContainer.style.display = "none";
  uploadBtn.disabled = true;
  progressBar.style.width = "0%";
  statusMessage.textContent = "";
  statusMessage.className = "status-message";
}

function showStatus(message, type) {
  statusMessage.textContent = message;
  statusMessage.className = "status-message";
  if (type) statusMessage.classList.add(type);
}

function setupRealtimeListener() {
  const channel = supabase
    .channel('images-changes')
    .on('postgres_changes', {
      event: 'DELETE',
      schema: 'public',
      table: 'images'
    }, (payload) => {
      const item = document.querySelector(`.gallery-item[data-id="${payload.old.id}"]`);
      if (item) {
        item.style.opacity = "0";
        item.style.transform = "scale(0.8)";
        setTimeout(() => {
          item.remove();
          if (gallery.children.length === 0) {
            gallery.innerHTML = '<p style="text-align:center;grid-column:1/-1;color:var(--gray)">Belum ada gambar yang diupload</p>';
          }
        }, 300);
      }
    })
    .subscribe();
}

// Inisialisasi
document.addEventListener("DOMContentLoaded", () => {
  if (!checkBrowserSupport()) {
    showStatus("Browser Anda mungkin tidak mendukung semua fitur. Gunakan metode upload alternatif.", "error");
  }
  loadImages();
  setupRealtimeListener();
});</script>
</body>
</html>